package com.aws.proj1.repo.impl;

import com.aws.proj1.config.AwsConfiguration;
import com.aws.proj1.constants.AWSConstants;
import com.aws.proj1.repo.S3Repo;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.nio.charset.StandardCharsets;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import lombok.extern.slf4j.Slf4j;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;

import com.amazonaws.services.s3.model.Bucket;
import com.amazonaws.services.s3.model.ObjectMetadata;
import com.amazonaws.services.s3.model.PutObjectRequest;

@Slf4j
@Repository
public class S3RepoImpl implements S3Repo {
	
	private static final Logger LOGGER = LoggerFactory.getLogger(S3RepoImpl.class);

	private static final String CREATING_THE_BUCKET_IF_NOT_EXISTS ="Creating the bucket if not exists.";
	private static final String BUCKET_EXITS_SO_RETURNING_THE_EXISTING_BUCKET ="The bucket exits, so returning the existing bucket.";
	private static final String CREATING_THE_BUCKET ="Creating the bucket {}";
	private static final String RETURNING_THE_BUCKET ="Returning the bucket.";
	private static final String INSERTING_THE_OBJECT_INTO_THE_BUCKET ="Inserting the object into the bucket.";
	private static final String SAVING_OUTPUT_PREDICTION_FOR_IMAGE ="saving output prediction for image = {}";
	
	@Autowired
	private AwsConfiguration awsConfiguration;

	@Override
	public Bucket createBucket() {
//		log.info(CREATING_THE_BUCKET_IF_NOT_EXISTS);
		Bucket b = null;
		if (awsConfiguration.amazonS3().doesBucketExist(AWSConstants.OUTPUT_S3)) {
//			log.info(BUCKET_EXITS_SO_RETURNING_THE_EXISTING_BUCKET);
			b = getBucket();
		} else {
//			log.info(CREATING_THE_BUCKET, AWSConstants.BUCKET_NAME);
			b = awsConfiguration.amazonS3().createBucket(AWSConstants.OUTPUT_S3);
		}

		return b;
	}

	@Override
	public Bucket getBucket() {
//		log.info(RETURNING_THE_BUCKET);
		Bucket namedBucket = null;
		List<Bucket> buckets = awsConfiguration.amazonS3().listBuckets();
		for (Bucket b : buckets) {
			if (b.getName().equals(AWSConstants.OUTPUT_S3)) {
				namedBucket = b;
			}
		}

		return namedBucket;
	}

	@Override
	public void putObject(String key, String value) {
//		log.info(INSERTING_THE_OBJECT_INTO_THE_BUCKET);
		this.createBucket();
        Map<String, String> predictionMap = new HashMap<String, String>(){{
            put(key, value);
        }};
        try {
            String prediction = new ObjectMapper().writeValueAsString(predictionMap);
//            log.info(SAVING_OUTPUT_PREDICTION_FOR_IMAGE, key);
            ObjectMetadata meta = new ObjectMetadata();
            meta.setContentLength(prediction.length());
            InputStream stream = new ByteArrayInputStream(prediction.getBytes(StandardCharsets.UTF_8));
            final PutObjectRequest putObjectRequest = new PutObjectRequest(AWSConstants.OUTPUT_S3, prediction, stream, meta);
            awsConfiguration.amazonS3().putObject(putObjectRequest);

        }catch (Exception e){
            System.err.println(e.getMessage());
        }
    }

}
